define("mediaServices",["lodash","constants","util","stateManagement","media-manager-api","image-client-api","MediaImageStudio","videoMakerOpener","UserFeedbackOpener","coreBi","experiment","coreUtilsLib"],function(I,e,C,w,a,g,t,i,o,n,r,s){"use strict";var A=n.events.singleVideoPlayer,d=C.backgroundUtils,P=d.getMediaPlayerVideoObject,F=d.getChangeVideoBiEventFields,R=d.getStoryboardDisplayValue,U=w.editorPlugins.userPreferences.actions.setSessionUserPreferences,c=w.editorPlugins.userPreferences.selectors.getSessionUserPreferences,m=w.editorPlugins.userPreferences.selectors.getMediaPath,l=e.CLIPART_DATA_KEYS,u=e.VECTOR_IMAGE_DEFAULTS,p=u.VECTOR_IMAGE_CATEGORY,h=u.VECTOR_SHAPE_DEFAULT_PATH,f=u.VECTOR_ART_DEFAULT_PATH,_="change_basic_shape";function v(e){var a=e.split("/");return 2===a.length?parseFloat(a[0])/parseFloat(a[1]):parseFloat(a[0])}function S(e){return 50<v(e)}function y(e){return e&&S(e)?30/v(e):1}return{create:function(k){function E(){var e=window.document.querySelector("#editor");if(e){var a=window.document,t=a.documentElement.scrollTop||a.body.scrollTop;e.focus(),a.documentElement.scrollTop=a.body.scrollTop=t}}function n(){return r.isOpen("specs.media.MediaManager3")||r.isOpen("specs.media.MediaManager3Migrate")?k.dsRead.generalInfo.media.getSiteUploadToken():k.dsRead.generalInfo.getSiteToken()}return{initMediaManager:function(e){k.mediaServices.mediaManager=a.create(I.assign(e,{origin:a.origins.EDITOR}))},mediaManager:null,initMediaStudio:function(e){var a=t.default;k.mediaServices.mediaStudio=new a(e)},mediaStudio:null,initVideoMaker:function(){k.mediaServices.videoMaker=new i.VideoMakerOpener},videoMaker:null,initUserFeedback:function(e){var a=o.default;k.mediaServices.userFeedback=new a(e)},userFeedback:null,hasSlowMo:S,getPlaybackSpeedByFPS:y,setFocusToEditor:E,changeWPhoto:function(c){var l=C.imageTransform.fittingTypes,u=k.components.data.get(c),e=k.store,p=e.dispatch,a=(0,e.getState)(),t=m(u.uri)(a);k.mediaServices.mediaManager.open(k.mediaServices.mediaManager.categories.IMAGE,"change_image",{translation:{title:C.translate("Image_Media_Choose_Image"),submitButton:C.translate("MMGR_submitbutton_onstage_image_uploads_choose")},path:t,multiSelect:!1,callback:function(e,a){if(e){var t=I.head(e),i=k.components.layout.get(c),n=k.components.properties.get(c).displayMode,o=t.width,r=t.height,s={width:o,height:r,uri:t.fileName,name:t.title,alt:t.title,crop:null,focalPoint:null,originalImageDataRef:null};if(u.crop&&k.imageCrop.isCropAllowed(s.uri)&&!C.url.isExternalUrl(s.uri)){var d=function(e,a,t,i,n){if(n!==g.fittingTypes.SCALE_TO_FILL&&n!==g.fittingTypes.LEGACY_FULL)return null;var o=Math.min(t/e,i/a),r=e*o,s=a*o;return{width:Math.round(r),height:Math.round(s),x:Math.round((t-r)/2),y:Math.round((i-s)/2)}}(i.width,i.height,o,r,n);s.crop=I.assign({},u.crop,d)}p(U("last_media_path_"+s.uri,a.path)),k.components.data.update(c,s,!0),n===C.imageTransform.fittingTypes.LEGACY_FULL&&k.components.properties.update(c,{displayMode:l.SCALE_TO_FILL},!0),k.history.add("Change Image"),E()}}})},changeVectorImage:function(n,e,a,o){var t=k.store.getState(),r=k.components.data.get(n),i=I.get(r,["svgId"]),s=k.media.vectorImage.getSvgInfoFromCache(i).svgType,d="shape"===s?h:f,c="shape"===s?_:"change_vector_art",l=m(i)(t)||a||d;k.mediaServices.mediaManager.open(k.mediaServices.mediaManager.categories[e||p],c,{multiSelect:!1,callback:function(e,a){if(!I.isEmpty(e)){var t=I.get(e,[0,"title"],""),i=I.get(e,[0,"uri"]);C.vectorImageUtils.replaceVectorImage(k,n,r,t,i,o),k.store.dispatch(U("last_media_path_"+i,a.path||"")),E()}},path:l})},changeClipArt:function(i,e){var a=k.components.data.get(i),t=k.store.getState(),n=m(a.uri)(t);k.mediaServices.mediaManager.open(e,{multiSelect:!1,translation:{submitButton:C.translate("MMGR_submitbutton_onstage_clipart_freeclipart_choose")},path:n,callback:function(e,a){if(e){var t=I.pick(e[0],l);t.uri=e[0].fileName,t.originalImageDataRef=null,t.crop=null,k.store.dispatch(U("last_media_path_"+t.uri,a.path)),k.components.data.update(i,t,!0),k.history.add("Change Clipart"),E()}}})},changeVideo:function(S){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:k.mediaServices.mediaManager.categories.VIDEO,a=k.store,y=a.dispatch,t=a.getState,M=k.components.design.get(S),b=k.components.properties.get(S),T=k.components.layout.get(S),i=I.get(M.background,["mediaRef","videoId"],""),n=I.get(M.background,["mediaRef","mediaFeatures"],[]),o=c("last_media_path_"+i)(t());!o&&I.includes(n,"alpha")&&(o="public/5d54b10e-e5e3-416b-9a2f-9316773f2a5b/078ecd58-f828-44f6-ac91-8cafbf5dbdae"),k.mediaServices.mediaManager.open(e,"change_video_box",{multiSelect:!1,callback:function(e,a){if(e){var t=I.head(e),i=P(t,a);if(I.includes(i.mediaFeatures,"alpha")){var n=I.maxBy(i.qualities,"width")||{},o=n.width/n.height,r=k.dsRead.components.layout.getLimits(I.isArray(S)?S[0]:S),s=I.assign({},r,T),d=C.layoutUtils.getLayoutWithAspectRatio(s,o,null);k.components.layout.update(S,d,!0)}var c,l,u,p,g=(c=M,l=i.mediaFeatures,u=I.includes(l,"alpha"),p=I.cloneDeep(c),u?(p.cssStyle={cssBorder:null,cssBorderRadius:null,cssBoxShadow:null},p.background.imageOverlay=null,p.background.colorOverlay=""):p.background.filterEffect=null,p);g.background.mediaRef=i,k.components.design.update(S,g,!0);var m={};I.get(b,"autoplay")&&I.assign(m,{autoplay:!0,mute:!0}),k.components.properties.update(S,m);var h=k.components.getChildren(S),f=I.find(h,function(e){return"wysiwyg.viewer.components.MediaControls"===k.components.getType(e)}),_=k.components.properties.get(f),v=I.get(_,"showStoryboard");_.showStoryboard=R(i,v),k.components.properties.update(f,_,!0),k.history.add("Change Video"),k.store.dispatch(w.editorPlugins.bi.actions.event(A.video_player_video_changed,F(e[0],"video_player_gfpp"))),y(U("last_media_path_"+i.videoId,a.path||"")),E()}},path:o})},changeShape:function(i){var e=k.mediaServices;e.mediaManager.open(e.mediaManager.categories.SHAPE,_,{multiSelect:!1,callback:function(e){if(!I.isEmpty(e)){var a=C.svgUrlParser.parseSvgSkinFromUrl(e[0].fileUrl),t=k.components.style.get(i);a!==t.skin&&(t.skin=a,k.components.style.update(i,t),k.history.add("Change Shape"),E())}},translation:{submitButton:C.translate("Shape_Media_Change_Shape")}})},getSiteUploadToken:n,transferMediaItems:function(e,a){var t=n(),i={items:e.map(function(e){return{item_id:e,item_type:"file"}}),destination:{site_token:t}};s.requestsUtil.fetch("//files.wix.com/site/media/editor/copy?site_token="+a,{method:"POST",credentials:"include",headers:new Headers({"content-type":"application/json; charset=utf-8"}),body:JSON.stringify(i)})}}}}});
//# sourceMappingURL=mediaServices.min.js.map