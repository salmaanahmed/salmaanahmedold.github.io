!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash")):"function"==typeof define&&define.amd?define(["lodash"],t):"object"==typeof exports?exports["host-worker-init"]=t(require("lodash")):e["host-worker-init"]=t(e.lodash)}(this,(function(e){return function(e){var t={};function r(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(o,s,function(t){return e[t]}.bind(null,s));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=14)}([function(t,r){t.exports=e},,function(e,t,r){"use strict";e.exports={APPS:{SANTA_MEMBERS:{appDefId:"14cc59bc-f0b7-15b8-e1c7-89ce41d0e0c9"},FORM_BUILDER:{appDefId:"14ce1214-b278-a7e4-1373-00cebd1bef7c"}},WIX_CODE_NAMESPACES_AND_ELEMENTORY_SUPPORT_PATH:"/wixCodeNamespacesAndElementorySupport.min.js",DATA_BINDING:"dataBinding",SEMI_NATIVE_SDK_URL:"http://static.parastorage.com/services/semi-native-sdk/1.3.0/lib/wix.min.js",PM_RPC_INTENTS:{INVOKE:"invoke",RPC_RESOLVE:"rpc-resolve",RPC_REJECT:"rpc-reject",API_DESCRIPTION:"api-desc",INVOKE_FUNCTION:"invoke-func",RESOLVE:"resolve",REJECT:"reject",REQUEST_API:"request-api"},WIX_CODE:{MESSAGE_INTENT:{WIX_CODE_MESSAGE:"WIX_CODE",WIX_CODE_SITE_API:"WIX_CODE_SITE_API",WIX_CODE_APP_API:"WIX_CODE_APP_API",SANTA_APPLICATION_CHANNEL_MESSAGE_RESPONSE:"SANTA_APPLICATION_CHANNEL_MESSAGE_RESPONSE",SANTA_APPLICATION_CHANNEL_MESSAGE:"SANTA_APPLICATION_CHANNEL_MESSAGE"},MESSAGE_TYPE:{CONSOLE:"console",IFRAME_COMMAND:"wix_code_iframe_command",GOOGLE_ANALYTICS:"googleAnalytics",UPDATE_WIX_CODE_MODEL_DATA_AFTER_LOGIN:"update_wix_code_model_data_after_login",REQUEST_API:"REQUEST_API",PERFORMANCE_METRICS_READY:"performance_metrics_ready",PLATFORM_PUBLIC_API_PREFIX:"viewer_platform_public_api_",OPEN_MESSAGE_CHANNEL:"openMessageChannel",SANTA_READY:"santaReady",SANTA_PAGE_CHANGE:"santaPageChange",WIX_CODE_WORKER_BI_DATA_UPDATE:"wix_code_worker_bi_data_update"}}}},,,,,function(e,t,r){"use strict";var o=r(0),s=r(15),n="platform_app_";function i(e){var t={},r=Object.keys(e).filter((function(e){return"string"==typeof e&&o.startsWith(e,n)})),s=Array.isArray(r),i=0;for(r=s?r:r[Symbol.iterator]();;){var a;if(s){if(i>=r.length)break;a=r[i++]}else{if((i=r.next()).done)break;a=i.value}var c=a;t[c.replace(n,"")]=e.getItem(c)}return t}e.exports={get:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=e?{localStorage:window.localStorage,sessionStorage:window.sessionStorage,memoryStorage:new s}:{localStorage:new s,sessionStorage:new s,memoryStorage:new s};return{serialize:function(){return JSON.stringify({local:i(t.localStorage),session:i(t.sessionStorage),memory:i(t.memoryStorage)})},setItem:function(e,r,o){t[e].setItem(n+r,o)}}}}},function(e,t,r){"use strict";var o=r(0),s=r(7),n=r(16),i=r(2);function a(){return"undefined"==typeof window||window.isPseudoWindow}function c(){var e="undefined"!=typeof window&&!window.clientSideRender,t=a();return{viewMode:this._hostProps.viewMode,locale:this._hostProps.locale,storage:this._storageManager.serialize(),userWarmup:this._hostProps.userWarmup,renderCycle:e&&!t?2:1,renderingEnv:t?"backend":"browser"}}var u=function(e,t){return o.startsWith(e,t)||o.startsWith(e,"http://localhost")||o.startsWith(e,"https://localhost")};function d(e,t,r,s){var i=0;return a()||(r=r&&window.fetch&&!function(e){return e.navigator&&/Edge|Trident/.test(e.navigator.userAgent)}(window),o.forEach(e,(function(e){if(r&&u(e.url,s))++i,window.fetch(e.url).then((function(e){return e.arrayBuffer()})).then((function(r){t.postMessage(n.scriptImportMessage(e.url,r),[r])}));else{var o="prefetch-"+e.id;if(!window.document.getElementById(o)){var a=window.document.createElement("link");a.setAttribute("rel","prefetch"),a.setAttribute("href",e.url),a.setAttribute("id",o),window.document.head.appendChild(a)}}}))),i}function p(e,t){if(!this._standbyWorker){var r=new window.Worker(this._hostProps.workerUrl);r.addEventListener("message",this.onmessage),this._standbyWorker=r,l.call(this,!!e,this._hostProps.staticServerUrl,t)}}function l(e,t,r){var s=this._options,a=s.applications,u=s.shouldUseWixCodeScripts,p=this._hostProps,l=p.openExperiments,_=p.baseVersion,f=p.santaBase,g=p.csrfToken,h=this._hostProps.biSessionData;r&&(h=o.assign(h,r));var w={id:"namespaces-sdk",url:this._options.namespacesSdkSource},E={id:"external-components",url:this._options.externalComponentsSource},m={id:"wixCodeNamespacesAndElementorySupport",url:this._options.wixCodeNamespacesAndElementorySupportSource},S={id:"wixCodeViewerApp",url:this._options.wixCodeViewerAppSource},y=d(function(e,t,r,s){var n=o.clone(e);return(s||o.some(t,(function(e){return e.id===i.DATA_BINDING||e.shouldUseWixCodeScripts})))&&(n=n.concat(r)),n.concat(t)}([w,E],a,[m,S],u),this._standbyWorker,e,t),A={sdkParameters:c.call(this),isDebug:this._options.isDebug,santaVersion:_,wixCodeBase:f+"/node_modules/viewer-platform-worker",sdkSource:"bundled",namespacesSdkSource:w.url,externalComponentsSource:E.url,applications:JSON.stringify(a),wixCodeNamespacesAndElementorySupportSource:m.url,wixCodeViewerAppSource:S.url,biSessionData:h,openExperiments:l,shouldUseWixCodeScripts:u,csrfToken:g},I=n.bootstrapMessage(A,y);this._standbyWorker.postMessage(I)}function _(e){this._workers[e]=this._standbyWorker,this._standbyWorker=null}function f(e,t){var r=this;return e.reduce((function(e,s){var n;return o.assign(e,((n={})[s]=r._hostProps.getUserCodeUrlsDetails(t,s),n))}),{})}function g(e){this.has(e)||(p.call(this),_.call(this,e))}function h(e){var t=this;Object.keys(e).forEach((function(r){var o=e[r];d(o),g.call(t,r),t.send(r,n.loadUserCodeMessage(r,o))}))}function w(e,t){var r=this;e.forEach((function(e){d(t),g.call(r,e),r.send(e,n.loadUserGeneratedApps(e,t))}))}function E(e){var t=this,r=this._workers[e];return!!r&&(delete this._workers[e],this._terminatedWorkers[e]=r,o.defer((function(){t.send(e,n.stopMessage(e)),delete t._terminatedWorkers[e]})),!0)}function m(e){var t=this,r=e.applications,s=e.rootIds,i=e.wixCodeScriptsByRootId,a=e.elementoryArguments,u=e.routersMap,d=e.sdkParameters,p=e.rgisByRootId,l=e.biSessionData;s.forEach((function(e){g.call(t,e);var s=o.assign({},d,c.call(t));t.send(e,n.loadMessage(e,a,i[e],r,s,u,t._storageManager.serialize(),p[e],l))}))}function S(e){var t=this,r=e.type,s=e.key,i=e.value;this._storageManager.setItem(r,s,i);var a=n.storageWasUpdatedMessage(this._storageManager.serialize());o.forEach(this._workers,(function(e,r){t.send(r,a)}))}function y(e){var t=this;return function(r){var s=r.data;o.isMatch(s,{intent:"BROWSER_API",type:"setToStorage"})&&S.call(t,s.data),e(r)}}function A(e){return function(t){var r=t.data,s=t.ports;o.includes(i.PM_RPC_INTENTS,r.intent)&&window.postMessage(r,"*",s),e(t)}}function I(e,t){var r,s,n=[],i=o.find(e,{id:t});return i&&n.push((s=(r=i).appConfig.userScript,{id:r.id,url:s.url,scriptName:s.scriptName,displayName:s.displayName,routerData:r.routerData})),n}var M=function(){function e(t,r,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._hostProps=function(e){var t={getElementoryArguments:function(){return null},getUserCodeUrlsDetails:I,loadUserCode:!0,viewMode:"site",locale:"",userWarmup:null,workerUrl:"",santaBase:"",baseVersion:"",openExperiments:[],biSessionData:{}};return o.assign({},t,e)}(t),this._options=s,this._workers={},this._terminatedWorkers={},this._standbyWorker=null,this._storageManager=r}return e.prototype.has=function(e){return Boolean(this._workers[e])},e.prototype.initialize=function(e,t){this.onmessage=A.call(this,y.call(this,(function(t){var r=t.data;return e(r)}))),p.call(this,t)},e.prototype.send=function(e,t,r){var o=n.isStopMessage(t)?this._terminatedWorkers[e]:this._workers[e];o&&(r?o.postMessage(t,r):o.postMessage(t))},e.prototype.get=function(e){return this._workers[e]},e.prototype.handleWidgetsCommand=function(e,t){var r=this;switch(e.type){case"load_user_code":if(!this._hostProps.loadUserCode)break;h.call(this,f.call(this,e.rootIds,e.widgets));break;case"load_user_generated_apps":w.call(this,e.rootIds,e.applications);break;case"load_widgets":m.call(this,{applications:o.reject(e.widgets,o.overSome({type:"Page"},{type:"Popup"},{type:"masterPage"})),rootIds:e.rootIds,wixCodeScriptsByRootId:f.call(this,e.rootIds,e.widgets),elementoryArguments:this._hostProps.getElementoryArguments(e.widgets),routersMap:e.routersMap,sdkParameters:e.sdkParameters,rgisByRootId:e.rgisByRootId,biSessionData:e.biSessionData});break;case"init_widgets":o.forEach(e.contexts,(function(e,t){if(!r.has(t))throw new Error("Context id "+t+" is not loaded");r.send(t,n.initMessage(t,e))}));break;case"start_widgets":if(!e.contexts)throw new Error("Start message must contain contexts property");o.forEach(e.contexts,(function(e,t){if(!r.has(t))throw new Error("Context id "+t+" is not loaded");r.send(t,n.startMessage(e,t))}));break;case"trigger_onRender":p.call(this,void 0,e.biDataUpdates),this.send(e.contextId,e);break;case"stop_widgets":o.forEach(e.widgetIds,(function(e){E.call(r,e)}));break;case"update_wix_code_model_data_after_login":o.forEach(e.rootIds,(function(t){r.send(t,n.updateWixCodeModelDataAfterLoginMessage(t,r._hostProps.getElementoryArguments(e.widgets)))}));break;case"wix_code_worker_bi_data_update":this.send(e.contextId,n.biUpdateMessage(e));break;default:this.has(e.contextId)&&this.send(e.contextId,e,t)}},e.prototype.terminateStandbyWorker=function(){this._standbyWorker&&(this._standbyWorker.terminate(),this._standbyWorker=null)},e}();e.exports={getWorkerManager:function(e,t,r){return new M(e,s.get(t),r)}}},function(e,t,r){"use strict";e.exports={get:function(){var e=[],t=null;return{sendOrHoldMessage:function(r,o){t?t(r,o):e.push({message:r,ports:o})},setMessageHandler:function(r){for(t=r;e.length>0;){var o=e.shift();t(o.message,o.ports)}}}}}},,,,,function(e,t,r){"use strict";var o=r(7),s=r(8),n=r(2),i=r(17),a=r(9);e.exports={storageFacade:o,constants:n,workerMessagesService:i,messageProxy:a,workerManagerFactory:s}},function(e,t,r){"use strict";var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return e.prototype.setItem=function(e,t){this[e]=String(t)},e.prototype.getItem=function(e){return this[e]||null},e.prototype.removeItem=function(e){delete this[e]},e.prototype.clear=function(){var e=this;Object.keys(this).forEach((function(t){return e.removeItem(t)}))},e.prototype.toJSON=function(){return this.storage.toJSON()},e}();e.exports=o},function(e,t,r){"use strict";e.exports={bootstrapMessage:function(e,t){return{type:"wix_code_worker_bootstrap",bootstrapArguments:e,fetchScriptsCount:t}},loadUserCodeMessage:function(e,t){return{type:"wix_code_worker_load_user_code",workerId:e,wixCode:t}},loadUserGeneratedApps:function(e,t){return{type:"wix_code_load_user_generated_apps",workerId:e,applications:t}},loadMessage:function(e,t,r,o,s,n,i,a,c){return{type:"wix_code_worker_load",workerId:e,elementoryArguments:t,wixCode:r,applications:o,sdkParameters:s,routersMap:n,storage:i,rgi:a,biSessionData:c}},initMessage:function(e,t){return{type:"wix_code_worker_init",id:e,apps:t}},startMessage:function(e,t){return{type:"wix_code_worker_start",context:e,id:t}},storageWasUpdatedMessage:function(e){return{type:"storageWasUpdated",storageValue:e}},updateWixCodeModelDataAfterLoginMessage:function(e,t){return{type:"update_wix_code_model_data_after_login",workerId:e,elementoryArguments:t}},scriptImportMessage:function(e,t){return{type:"script_import_message",url:e,script:t}},stopMessage:function(e){return{contextId:e,type:"stop"}},isStopMessage:function(e){return"stop"===e.type},biUpdateMessage:function(e){return{type:"wix_code_worker_bi_data_update",updates:e.updates}}}},function(e,t,r){"use strict";var o=r(0),s=r(8),n=r(9),i=r(2);e.exports={getAPI:function(){var e=n.get(),t=[],r=[],a=!1,c=void 0;function u(e){t.forEach((function(t){t(e)}))}return{init:function(t){var r=function(e){return o.assign({applications:[],fetchScripts:!0},e)}(t),n=r.workerProps,i=r.fetchScripts;(c=s.getWorkerManager(n,function(){try{return window.localStorage.setItem("",""),window.localStorage.removeItem(""),!0}catch(e){return!1}}(),r)).initialize(u,i),e.setMessageHandler((function(e,t){return c.handleWidgetsCommand(e,t)})),a=!0},sendMessage:function(t,s){var n={intent:i.WIX_CODE.MESSAGE_INTENT.WIX_CODE_MESSAGE};(t=o.defaults({},t,n))&&e.sendOrHoldMessage(function(e){return r.reduce((function(e,t){return t(e)}),e)}(t),s)},sendOrHoldMessage:function(t){e.sendOrHoldMessage(t)},registerMessageHandler:function(e){t.push(e)},registerMessageModifier:function(e){r.push(e)},isAppInitiated:function(){return a},getWorkerById:function(e){return c&&c.get(e)},destroyAppsContainer:function(){c&&(c.terminateStandbyWorker(),a=!1,e=n.get())}}}}}])}));
//# sourceMappingURL=host-worker-init.js.map